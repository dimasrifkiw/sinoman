<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>SINOMAN Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      display: flex;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
    }
    .sidebar {
      width: 250px;
      background-color: #f0e68c;
      color: white;
      display: flex;
      flex-direction: column;
      padding-top: 1rem;
    }
    .sidebar img {
      width: 160px;
      margin: 0 auto 1rem;
    }
    .nav-link {
      color: #0f3553;
      padding: 1rem;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-weight: 500;
    }
    .nav-link:hover, .nav-link.active {
      background-color: #0f3553;
      color: white !important;
    }
    .main {
      flex: 1;
      background-color: #f8f9fa;
      padding: 2rem;
    }
    .hidden { display: none; }
    .drop-zone {
      border: 2px dashed #ccc;
      padding: 2rem;
      text-align: center;
      border-radius: 10px;
      background-color: #fff;
      cursor: pointer;
    }
    .drop-zone:hover {
      background-color: #f0f0f0;
    }
    .file-list {
      margin-top: 1rem;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      background: #fff;
      border: 1px solid #ddd;
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 5px;
    }
    table {
      margin-top: 1rem;
      background: white;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
    }
    .search-bar {
      margin: 1rem 0;
    }
  </style>
</head>
<body>

  <!-- Sidebar Navigasi -->
  <div class="sidebar">
    <img src="sinoman.png" alt="Logo SINOMAN">
    <a href="#" class="nav-link active" onclick="showSection('upload', this)"><i class="fas fa-upload"></i> Upload Data</a>
    <a href="#" class="nav-link" onclick="showSection('data', this)"><i class="fas fa-home"></i> Data Rumah Tangga</a>
    <a href="#" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="#" class="nav-link"><i class="fas fa-users"></i> Manajemen User</a>
    <a href="#" class="nav-link"><i class="fas fa-cog"></i> Pengaturan</a>
  </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Upload Section -->
    <div id="upload-section">
      <h2>Upload Data Excel</h2>
      <p>Unggah data rumah tangga dalam format Excel</p>
      <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-file-excel fa-3x text-primary mb-2"></i>
        <p>Drag & drop file Excel disini atau</p>
        <button class="btn btn-primary"><i class="fas fa-upload"></i> Pilih File</button>
        <p class="mt-2 text-muted">Format yang didukung: .xlsx, .xls</p>
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
      </div>
    </div>

    <!-- Data Section -->
    <div id="data-section" class="hidden">
      <h2>Data Rumah Tangga</h2>
      <input type="text" class="form-control search-bar" id="searchInput" oninput="filterFiles()" placeholder="Cari berdasarkan Kalurahan...">
      <div class="file-list" id="fileList"></div>
      <div id="tableContainer" class="mt-4"></div>
    </div>
  </div>

  <script>
    const uploadedFiles = []; // Menyimpan semua file yang sudah diunggah
    let visibleIndex = null;  // Untuk melacak file yang sedang ditampilkan

    function showSection(section, clickedLink) {
      // Menampilkan section berdasarkan klik navigasi
      document.getElementById('upload-section').classList.add('hidden');
      document.getElementById('data-section').classList.add('hidden');
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

      if (section === 'upload') {
        document.getElementById('upload-section').classList.remove('hidden');
      } else if (section === 'data') {
        document.getElementById('data-section').classList.remove('hidden');
        renderFileList(); // Tampilkan daftar file
      }

      if (clickedLink) clickedLink.classList.add('active');
    }

    function handleFileUpload(event) {
      // Fungsi saat file diunggah
      const file = event.target.files[0];
      if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          uploadedFiles.push({ name: file.name, data: json });
          alert('File "' + file.name + '" berhasil diunggah!');
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert('Hanya file .xlsx atau .xls yang diperbolehkan.');
      }
    }

    function renderFileList(filteredFiles = null) {
      // Menampilkan daftar file (bisa semua atau hasil filter)
      const listContainer = document.getElementById('fileList');
      const tableContainer = document.getElementById('tableContainer');
      listContainer.innerHTML = '';
      tableContainer.innerHTML = '';
      const filesToShow = filteredFiles || uploadedFiles;

      if (filesToShow.length === 0) {
        listContainer.innerHTML = '<p class="text-muted">Tidak ada file yang sesuai.</p>';
        return;
      }

      filesToShow.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
          <span>${file.name}</span>
          <div>
            <button class="btn btn-sm btn-secondary" onclick="toggleFile(${index})"><i class="fas fa-eye"></i> Lihat</button>
            <button class="btn btn-sm btn-danger" onclick="deleteFile(${index})"><i class="fas fa-trash-alt"></i> Hapus</button>
          </div>
        `;
        listContainer.appendChild(item);
      });

      visibleIndex = null; // Reset tampilan jika sebelumnya ada file terlihat
    }

    function toggleFile(index) {
      // Menampilkan / menyembunyikan isi data file
      const tableContainer = document.getElementById('tableContainer');
      if (visibleIndex === index) {
        tableContainer.innerHTML = '';
        visibleIndex = null;
      } else {
        const data = uploadedFiles[index].data;
        let html = '<table class="table table-bordered"><thead><tr>';
        data[0].forEach(cell => html += `<th>${cell}</th>`);
        html += '</tr></thead><tbody>';
        for (let i = 1; i < data.length; i++) {
          html += '<tr>';
          data[i].forEach(cell => html += `<td>${cell ?? ''}</td>`);
          html += '</tr>';
        }
        html += '</tbody></table>';
        tableContainer.innerHTML = html;
        visibleIndex = index;
      }
    }

    function deleteFile(index) {
      // Menghapus file dari daftar
      if (confirm('Yakin ingin menghapus file ini?')) {
        uploadedFiles.splice(index, 1);
        filterFiles(); // Refresh dengan filter saat ini
      }
    }

    function filterFiles() {
      // Filter berdasarkan kata kunci pencarian di kolom "kalurahan"/"kelurahan"
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      if (keyword === '') {
        renderFileList(); // Tampilkan semua jika kosong
        return;
      }

      const result = uploadedFiles.filter(file => {
        const headers = file.data[0].map(h => (h || '').toString().toLowerCase());
        const kalurahanIndex = headers.findIndex(h => h.includes('kalurahan') || h.includes('kelurahan'));

        if (kalurahanIndex === -1) return false; // Kolom tidak ditemukan

        // Cek baris apakah ada yang mengandung keyword
        for (let i = 1; i < file.data.length; i++) {
          const row = file.data[i];
          const cell = (row[kalurahanIndex] || '').toString().toLowerCase();
          if (cell.includes(keyword)) return true;
        }
        return false;
      });

      renderFileList(result);
    }
  </script>

</body>
</html>
